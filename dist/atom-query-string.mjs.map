{"version":3,"sources":["../src/atom-query-string.ts"],"sourcesContent":["import { WritableAtom, atom } from \"jotai\";\r\nimport { RESET } from \"jotai/utils\";\r\n\r\ntype Unsubscribe = () => void;\r\n\r\ntype SetStateActionWithReset<Value> =\r\n  | Value\r\n  | typeof RESET\r\n  | ((prev: Value) => Value);\r\n\r\nexport interface QueryString<Value> {\r\n  parse: (str: string, initialValue: Value) => Value;\r\n  stringify: (obj: Value) => string;\r\n  get: (initialValue: Value) => Value;\r\n  subscribe?: (\r\n    callback: (value: Value) => void,\r\n    initialValue: Value\r\n  ) => Unsubscribe;\r\n}\r\n\r\nexport interface AtomWithQueryStringOptions<Value> {\r\n  onValueChange?: (value: Value) => void;\r\n  onPathnameChange?: (pathname: string) => void;\r\n  queryString?: QueryString<Value>;\r\n  getOnInit?: boolean;\r\n}\r\n\r\nfunction isNumber(num: any) {\r\n  if (typeof num === \"number\") {\r\n    return num - num === 0;\r\n  }\r\n  if (typeof num === \"string\" && num.trim() !== \"\") {\r\n    return Number.isFinite ? Number.isFinite(+num) : isFinite(+num);\r\n  }\r\n  return false;\r\n}\r\n\r\nfunction toNumberable(value: any): any {\r\n  if (Array.isArray(value)) {\r\n    return value.map((item: any) => toNumberable(item));\r\n  }\r\n  switch (typeof value) {\r\n    case \"string\":\r\n      return isNumber(value) ? Number(value) : value;\r\n\r\n    default:\r\n      return value;\r\n  }\r\n}\r\n\r\nfunction createQueryString<Value>(): QueryString<Value> {\r\n  const queryString: QueryString<Value> = {\r\n    parse: (str, initialValue) => {\r\n      const output: Record<string, any> = {};\r\n      const urlParams = new URLSearchParams(str);\r\n\r\n      // Set will return only unique keys()\r\n      new Set([...urlParams.keys()]).forEach((key) => {\r\n        output[key] =\r\n          urlParams.getAll(key).length > 1\r\n            ? urlParams.getAll(key)\r\n            : initialValue instanceof Object &&\r\n              key in initialValue &&\r\n              typeof initialValue[key as keyof typeof initialValue] === \"number\"\r\n            ? toNumberable(urlParams.get(key))\r\n            : urlParams.get(key);\r\n      });\r\n\r\n      return output as Value;\r\n    },\r\n    stringify: (obj) => {\r\n      const output = Object.entries(obj as Record<string, any>)\r\n        .flatMap(([key, value]) => {\r\n          if (Array.isArray(value)) {\r\n            return value.map((item) => {\r\n              if (item == undefined || item == null) return;\r\n              return encodeURIComponent(key) + \"=\" + encodeURIComponent(item);\r\n            });\r\n          }\r\n          if (value == undefined || value == null) return;\r\n          return encodeURIComponent(key) + \"=\" + encodeURIComponent(value);\r\n        })\r\n        .join(\"&\");\r\n      return output;\r\n    },\r\n    get: (initialValue) => {\r\n      const url = new URL(window.location.href);\r\n\r\n      for (const k of url.searchParams.keys()) {\r\n        if (!(k in (initialValue as Record<string, any>))) {\r\n          url.searchParams.delete(k);\r\n        }\r\n      }\r\n      const urlParsed = queryString.parse(\r\n        url.searchParams.toString(),\r\n        initialValue\r\n      );\r\n      const newValue = Object.assign({}, initialValue, urlParsed);\r\n\r\n      return newValue;\r\n    },\r\n  };\r\n  if (\r\n    typeof window !== \"undefined\" &&\r\n    typeof window.addEventListener === \"function\"\r\n  ) {\r\n    queryString.subscribe = (callback, initialValue) => {\r\n      const popstateEventCallback = (e: PopStateEvent) => {\r\n        callback(queryString.get(initialValue));\r\n      };\r\n      window.addEventListener(\"popstate\", popstateEventCallback);\r\n      return () => {\r\n        window.removeEventListener(\"popstate\", popstateEventCallback);\r\n      };\r\n    };\r\n  }\r\n  return queryString;\r\n}\r\n\r\nconst defaultQueryString = createQueryString();\r\n\r\nexport function atomWithQueryString<Value extends object>(\r\n  initialValue: Value,\r\n  {\r\n    onValueChange,\r\n    onPathnameChange,\r\n    queryString = defaultQueryString as QueryString<Value>,\r\n    getOnInit,\r\n  }: AtomWithQueryStringOptions<Value> = {}\r\n) {\r\n  const baseAtom = atom(\r\n    getOnInit ? queryString.get(initialValue) : initialValue\r\n  );\r\n  const anAtom = atom(\r\n    (get) => get(baseAtom),\r\n    (\r\n      get,\r\n      set,\r\n      update: SetStateActionWithReset<Value>,\r\n      isPushState: boolean = true\r\n    ) => {\r\n      const nextValue =\r\n        update === RESET\r\n          ? initialValue\r\n          : update instanceof Function\r\n          ? update(get(baseAtom))\r\n          : update;\r\n\r\n      set(baseAtom, nextValue);\r\n      onValueChange?.(nextValue);\r\n\r\n      if (isPushState) {\r\n        const url = new URL(window.location.href);\r\n        const parsed = queryString.parse(\r\n          url.searchParams.toString(),\r\n          initialValue\r\n        );\r\n        const searchParams = queryString.stringify(\r\n          Object.assign(parsed, nextValue)\r\n        );\r\n\r\n        const resultUrl =\r\n          update === RESET ? url.pathname : url.pathname + \"?\" + searchParams;\r\n\r\n        if (onPathnameChange instanceof Function) {\r\n          onPathnameChange(resultUrl);\r\n        } else {\r\n          window.history.pushState(null, \"\", resultUrl);\r\n        }\r\n      }\r\n    }\r\n  );\r\n\r\n  anAtom.onMount = (setAtom) => {\r\n    if (!getOnInit) setAtom(queryString.get(initialValue), false);\r\n    let unsub: Unsubscribe | undefined;\r\n    if (queryString.subscribe) {\r\n      unsub = queryString.subscribe(setAtom, initialValue);\r\n    }\r\n    return unsub;\r\n  };\r\n\r\n  return anAtom;\r\n}\r\n"],"mappings":"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","names":[]}